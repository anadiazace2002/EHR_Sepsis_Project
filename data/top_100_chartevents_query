WITH sepsis_cohort AS (
    -- cohort from step 1
    SELECT a.HADM_ID, a.ADMITTIME
    FROM ADMISSIONS a
    JOIN DIAGNOSES_ICD d ON a.HADM_ID = d.HADM_ID
    JOIN PATIENTS p ON a.SUBJECT_ID = p.SUBJECT_ID
    WHERE d.ICD9_CODE IN ('99592', '78552')
    AND d.HADM_ID NOT IN (SELECT HADM_ID FROM DIAGNOSES_ICD WHERE ICD9_CODE = 'V667')
    AND (TIMESTAMPDIFF(DAY, p.DOB, a.ADMITTIME) / 365.25) >= 18
    GROUP BY a.HADM_ID, a.ADMITTIME
)
SELECT 
    ce.ITEMID,
    di.LABEL AS measure_name,
    di.CATEGORY, -- Importante para ver qu√© es
    COUNT(DISTINCT sc.HADM_ID) AS num_patients
FROM 
    sepsis_cohort sc
JOIN 
    CHARTEVENTS ce ON sc.HADM_ID = ce.HADM_ID
JOIN 
    D_ITEMS di ON ce.ITEMID = di.ITEMID
WHERE 
    ce.CHARTTIME BETWEEN sc.ADMITTIME AND DATE_ADD(sc.ADMITTIME, INTERVAL 1 DAY)
    AND ce.VALUENUM IS NOT NULL
    -- filter administrative categories
    AND di.CATEGORY NOT IN ('General', 'Treatments', 'Care Plans', 'Administrative', 'ADT')
    -- AND di.CATEGORY IN ('Routine Vital Signs', 'Respiratory', 'Labs')
GROUP BY 
    ce.ITEMID, di.LABEL, di.CATEGORY
ORDER BY 
    num_patients DESC
LIMIT 100;
