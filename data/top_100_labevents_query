WITH sepsis_cohort AS (
    -- cohort from step 1
    SELECT a.HADM_ID, a.ADMITTIME
    FROM ADMISSIONS a
    JOIN DIAGNOSES_ICD d ON a.HADM_ID = d.HADM_ID
    JOIN PATIENTS p ON a.SUBJECT_ID = p.SUBJECT_ID
    WHERE d.ICD9_CODE IN ('99592', '78552')
    AND d.HADM_ID NOT IN (SELECT HADM_ID FROM DIAGNOSES_ICD WHERE ICD9_CODE = 'V667')
    AND (TIMESTAMPDIFF(DAY, p.DOB, a.ADMITTIME) / 365.25) >= 18
    GROUP BY a.HADM_ID, a.ADMITTIME
)
SELECT 
    le.ITEMID,
    dl.LABEL AS test_name,
    dl.FLUID,
    dl.CATEGORY,
    COUNT(DISTINCT sc.HADM_ID) AS num_patients
FROM 
    sepsis_cohort sc
JOIN 
    LABEVENTS le ON sc.HADM_ID = le.HADM_ID
JOIN 
    D_LABITEMS dl ON le.ITEMID = dl.ITEMID
WHERE 
    le.CHARTTIME BETWEEN sc.ADMITTIME AND DATE_ADD(sc.ADMITTIME, INTERVAL 1 DAY)
    -- filter relevant data
    AND dl.FLUID IN ('Blood', 'Urine') 
GROUP BY 
    le.ITEMID, dl.LABEL, dl.FLUID, dl.CATEGORY
ORDER BY 
    num_patients DESC
LIMIT 100;
